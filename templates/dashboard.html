{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div id="dashboard-page" data-selected-date="{{ selected_date }}" data-is-today="{{ is_today }}">

    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Dashboard</h1>
        <div class="d-flex align-items-center">
            <label for="dashboard-date-picker" class="col-form-label me-2">Date:</label>
            <input type="date" id="dashboard-date-picker" class="form-control" style="width: auto;" value="{{ selected_date }}">
        </div>
    </div>

    <!-- ▼▼▼ 植物中心のカード表示エリア ▼▼▼ -->
    <h2 class="h3">Managed Plants Status</h2>
    <div id="plant-cards-container" class="row">
        {% for plant_item in plants_data %}
        <div class="col-xl-4 col-md-6 mb-4">
            <a href="{{ url_for('dashboard.plant_detail', managed_plant_id=plant_item.managed_plant_id) }}" class="text-decoration-none text-dark">
                <div id="plant-card-{{ plant_item.managed_plant_id }}" class="card h-100 shadow-sm plant-card">
                    <div class="row g-0 h-100">
                        <div class="col-4">
                            <img src="{{ plant_item.image_url or 'https://placehold.co/400x600/eeeeee/cccccc?text=No+Image' }}" 
                                 onerror="this.onerror=null;this.src='https://placehold.co/400x600/eeeeee/cccccc?text=No+Image';"
                                 class="img-fluid rounded-start h-100 w-100" 
                                 alt="{{ plant_item.plant_name }}">
                        </div>
                        <div class="col-8 d-flex flex-column">
                            <div class="card-header bg-white border-bottom-0">
                                <h5 class="card-title mb-0" style="font-size: 1.1rem;">{{ plant_item.plant_name }}</h5>
                                <small class="text-muted">{{ plant_item.genus }} {{ plant_item.species }}</small>
                            </div>
                            <div class="card-body py-2">
                                <h6 class="card-subtitle mb-2 text-muted small"><i class="bi bi-hdd-stack"></i> Sensor Readings</h6>
                                {% set sensor_data = plant_item.sensors.get('primary', {}) %}
                                <div class="row text-center sensor-data-grid">
                                    <div class="col-6 mb-2">
                                        <i class="bi bi-thermometer-half text-danger"></i>
                                        <span id="temp-{{ plant_item.managed_plant_id }}" class="fs-6 fw-bold">
                                            {{ sensor_data.temperature | round(1) if sensor_data and 'temperature' in sensor_data and sensor_data.temperature is not none else '--' }}
                                        </span> °C
                                    </div>
                                    <div class="col-6 mb-2">
                                        <i class="bi bi-droplet-half text-primary"></i> 
                                        <span id="humidity-{{ plant_item.managed_plant_id }}" class="fs-6 fw-bold">
                                            {{ sensor_data.humidity | round(1) if sensor_data and 'humidity' in sensor_data and sensor_data.humidity is not none else '--' }}
                                        </span> %
                                    </div>
                                    <div class="col-6">
                                        <i class="bi bi-brightness-high text-warning"></i> 
                                        <span id="light-{{ plant_item.managed_plant_id }}" class="fs-6 fw-bold">
                                            {{ sensor_data.light_lux | round(1) if sensor_data and 'light_lux' in sensor_data and sensor_data.light_lux is not none else '--' }}
                                        </span> lx
                                    </div>
                                    <div class="col-6">
                                        <i class="bi bi-moisture text-success"></i> 
                                        <span id="soil-{{ plant_item.managed_plant_id }}" class="fs-6 fw-bold">
                                            {{ sensor_data.soil_moisture if sensor_data and 'soil_moisture' in sensor_data and sensor_data.soil_moisture is not none else '--' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-white mt-auto">
                                <h6 class="card-subtitle mb-2 text-muted small"><i class="bi bi-clipboard-data"></i> Latest Analysis</h6>
                                <div id="analysis-{{ plant_item.managed_plant_id }}" class="analysis-section">
                                    <span class="badge bg-light text-dark me-2">
                                        <i class="bi bi-sun"></i> Growth: 
                                        <strong id="growth-{{ plant_item.managed_plant_id }}">{{ plant_item.analysis.growth_period | replace('_', ' ') | title | default('Unknown') }}</strong>
                                    </span>
                                    <span class="badge {% if plant_item.analysis.watering_status == 'needed' %}bg-primary text-white{% else %}bg-light text-dark{% endif %}">
                                        {% if plant_item.analysis.watering_status == 'needed' %}<i class="bi bi-exclamation-triangle-fill me-1"></i>{% else %}<i class="bi bi-water"></i>{% endif %}
                                        Advice: 
                                        <strong id="watering-{{ plant_item.managed_plant_id }}">{{ plant_item.analysis.watering_advice | default('N/A') }}</strong>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </a>
        </div>
        {% else %}
            <div class="col">
                <div class="alert alert-light text-center">
                    <p class="fs-4"><i class="bi bi-info-circle"></i> No managed plants found.</p>
                    <p>Go to the <a href="{{ url_for('management.management') }}" class="alert-link">Management</a> page to add a plant.</p>
                </div>
            </div>
        {% endfor %}
    </div>
    <!-- ▲▲▲ 植物中心のカード表示エリア ▲▲▲ -->

    <hr class="my-4">

    <!-- SwitchBot履歴グラフエリア -->
    <h2 class="h3">Environment History</h2>
    <div class="row">
        {% for switchbot in switchbots_for_chart %}
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5><i class="bi bi-graph-up"></i> {{ switchbot.device_name }}</h5>
                </div>
                <div class="card-body">
                    <div class="btn-group btn-group-sm mb-3" role="group">
                        <button type="button" class="btn btn-outline-secondary period-btn active" data-period="24h" data-device-id="{{ switchbot.device_id }}">24H</button>
                        <button type="button" class="btn btn-outline-secondary period-btn" data-period="7d" data-device-id="{{ switchbot.device_id }}">7D</button>
                        <button type="button" class="btn btn-outline-secondary period-btn" data-period="30d" data-device-id="{{ switchbot.device_id }}">1M</button>
                        <button type="button" class="btn btn-outline-secondary period-btn" data-period="1y" data-device-id="{{ switchbot.device_id }}">1Y</button>
                    </div>
                    <div class="position-relative" style="height:300px">
                        <canvas id="history-chart-{{ switchbot.device_id }}"></canvas>
                        <div id="chart-loader-{{ switchbot.device_id }}" class="position-absolute top-50 start-50 translate-middle d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col">
            <div class="alert alert-light">No SwitchBot devices registered for history view.</div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
