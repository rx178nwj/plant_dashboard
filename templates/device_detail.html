{% extends "layout.html" %}

{% block title %}{{ device.device_name }} - Device Details{% endblock %}

{% block content %}
<div id="device-detail-page" 
     data-device-id="{{ device.device_id }}" 
     data-library-plant-id="{{ device.assigned_plant.library_plant_id if device.assigned_plant else '' }}">
    
    <!-- Alert box for this page -->
    <div id="device-detail-alert-box"></div>

    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="bi bi-cpu"></i> {{ device.device_name }}
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="{{ url_for('devices.devices_profiles') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Device Profiles
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Device Information Card -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Device Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Device ID:</div>
                        <div class="col-md-8"><code>{{ device.device_id }}</code></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Device Name:</div>
                        <div class="col-md-8">{{ device.device_name }}</div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">MAC Address:</div>
                        <div class="col-md-8"><code>{{ device.mac_address }}</code></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Device Type:</div>
                        <div class="col-md-8">
                            {% if device.device_type == 'plant_sensor' %}
                                <span class="badge bg-success"><i class="bi bi-flower2"></i> Plant Sensor</span>
                            {% else %}
                                <span class="badge bg-info"><i class="bi bi-thermometer-sun"></i> {{ device.device_type.replace('switchbot_', '').replace('_', ' ').title() }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Connection Status:</div>
                        <div class="col-md-8">
                            {% if device.connection_status == 'connected' %}
                                <span class="badge bg-success"><i class="bi bi-check-circle"></i> Connected</span>
                            {% else %}
                                <span class="badge bg-secondary"><i class="bi bi-x-circle"></i> Disconnected</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if device.last_seen %}
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Last Seen:</div>
                        <div class="col-md-8">{{ device.last_seen }}</div>
                    </div>
                    {% endif %}
                    {% if device.battery_level %}
                    <div class="row mb-3">
                        <div class="col-md-4 fw-bold">Battery Level:</div>
                        <div class="col-md-8">
                            <span class="badge bg-primary">{{ device.battery_level }}%</span>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Latest Sensor Data Card -->
            {% set sensor = device.sensor_data %}
            {% if sensor %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Latest Sensor Data</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        {% if sensor.temperature is not none %}
                        <div class="col-md-3 mb-3">
                            <i class="bi bi-thermometer-half text-danger" style="font-size: 2rem;"></i>
                            <div class="mt-2">
                                <div class="fs-4 fw-bold">{{ sensor.temperature | round(1) }}°C</div>
                                <div class="text-muted small">Temperature</div>
                            </div>
                        </div>
                        {% endif %}

                        {% if sensor.humidity is not none %}
                        <div class="col-md-3 mb-3">
                            <i class="bi bi-droplet-half text-primary" style="font-size: 2rem;"></i>
                            <div class="mt-2">
                                <div class="fs-4 fw-bold">{{ sensor.humidity | round(1) }}%</div>
                                <div class="text-muted small">Humidity</div>
                            </div>
                        </div>
                        {% endif %}

                        {% if sensor.light_lux is not none %}
                        <div class="col-md-3 mb-3">
                            <i class="bi bi-brightness-high text-warning" style="font-size: 2rem;"></i>
                            <div class="mt-2">
                                <div class="fs-4 fw-bold">{{ sensor.light_lux | round(1) }}</div>
                                <div class="text-muted small">Light (lx)</div>
                            </div>
                        </div>
                        {% endif %}

                        {% if sensor.soil_moisture is not none %}
                        <div class="col-md-3 mb-3">
                            <i class="bi bi-moisture text-success" style="font-size: 2rem;"></i>
                            <div class="mt-2">
                                <div class="fs-4 fw-bold">{{ sensor.soil_moisture }}</div>
                                <div class="text-muted small">Soil Moisture</div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% if sensor.timestamp %}
                    <div class="text-center mt-2">
                        <small class="text-muted"><i class="bi bi-clock"></i> Last updated: {{ sensor.timestamp }}</small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Sensor Graph -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-graph-up"></i> Sensor Graph</h5>
                </div>
                <div class="card-body">
                    {% set device_id_to_chart = device.device_id %}
                    <div class="d-flex justify-content-between align-items-center flex-wrap mb-3">
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary period-btn active" data-period="24h" data-device-id="{{ device_id_to_chart }}">24H</button>
                            <button type="button" class="btn btn-outline-secondary period-btn" data-period="7d" data-device-id="{{ device_id_to_chart }}">7D</button>
                            <button type="button" class="btn btn-outline-secondary period-btn" data-period="30d" data-device-id="{{ device_id_to_chart }}">1M</button>
                            <button type="button" class="btn btn-outline-secondary period-btn" data-period="1y" data-device-id="{{ device_id_to_chart }}">1Y</button>
                        </div>
                        <div class="d-flex align-items-center mt-2 mt-md-0">
                            <label for="sensor-date-picker-{{ device_id_to_chart }}" class="col-form-label-sm me-2">Date:</label>
                            <input type="date" id="sensor-date-picker-{{ device_id_to_chart }}" class="form-control form-control-sm" style="width: auto;">
                        </div>
                    </div>
                    <div class="d-flex flex-wrap justify-content-center small mb-2 chart-options" id="chart-options-{{ device_id_to_chart }}" style="display: none;">
                        <div class="form-check form-switch me-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="toggle-fast_growth-{{ device_id_to_chart }}" data-dataset-label="Fast Growth Range" checked>
                            <label class="form-check-label" for="toggle-fast_growth-{{ device_id_to_chart }}"><span class="badge" style="background-color: rgba(40, 167, 69, 0.5); color: white;">Fast Growth</span></label>
                        </div>
                        <div class="form-check form-switch me-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="toggle-slow_growth-{{ device_id_to_chart }}" data-dataset-label="Slow Growth Range" checked>
                            <label class="form-check-label" for="toggle-slow_growth-{{ device_id_to_chart }}"><span class="badge" style="background-color: rgba(25, 135, 84, 0.5); color: white;">Slow Growth</span></label>
                        </div>
                        <div class="form-check form-switch me-3">
                            <input class="form-check-input" type="checkbox" role="switch" id="toggle-hot_dormancy-{{ device_id_to_chart }}" data-dataset-label="Hot Dormancy Range" checked>
                            <label class="form-check-label" for="toggle-hot_dormancy-{{ device_id_to_chart }}"><span class="badge" style="background-color: rgba(255, 193, 7, 0.5); color: #333;">Hot Dormancy</span></label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="toggle-cold_dormancy-{{ device_id_to_chart }}" data-dataset-label="Cold Dormancy Range" checked>
                            <label class="form-check-label" for="toggle-cold_dormancy-{{ device_id_to_chart }}"><span class="badge" style="background-color: rgba(13, 202, 240, 0.5); color: #333;">Cold Dormancy</span></label>
                        </div>
                    </div>
                    <div class="position-relative" style="height:300px">
                        <canvas id="history-chart-{{ device_id_to_chart }}"></canvas>
                        <div id="chart-loader-{{ device_id_to_chart }}" class="position-absolute top-50 start-50 translate-middle d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Assigned Plant Card -->
            {% if device.assigned_plant %}
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="bi bi-flower2"></i> Assigned Plant</h5>
                </div>
                <div class="card-body text-center">
                    {% if device.assigned_plant.display_image_url %}
                    <img src="{{ device.assigned_plant.display_image_url }}"
                         onerror="this.onerror=null;this.src='https://placehold.co/200x300/eeeeee/cccccc?text=No+Image';"
                         class="img-fluid rounded mb-3"
                         style="max-height: 200px; object-fit: cover;"
                         alt="{{ device.assigned_plant.plant_name }}">
                    {% endif %}
                    <h5 class="card-title">{{ device.assigned_plant.plant_name }}</h5>
                    <p class="text-muted">
                        <em>{{ device.assigned_plant.genus }} {{ device.assigned_plant.species }}</em>
                    </p>
                    <a href="{{ url_for('dashboard.plant_detail', managed_plant_id=device.assigned_plant.managed_plant_id) }}"
                       class="btn btn-sm btn-outline-success">
                        <i class="bi bi-eye"></i> View Plant Details
                    </a>
                </div>
            </div>
            {% elif device.device_type == 'plant_sensor' %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-flower2"></i> Assigned Plant</h5>
                </div>
                <div class="card-body text-center">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <p class="mt-2 text-muted">No plant assigned to this sensor</p>
                    <a href="{{ url_for('management.management') }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-plus-circle"></i> Assign Plant
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Quick Actions Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary" disabled>
                            <i class="bi bi-pencil"></i> Edit Device
                        </button>
                        {% if device.device_type == 'plant_sensor' %}
                        <a href="{{ url_for('devices.device_threshold_config', device_id=device.device_id) }}" class="btn btn-outline-info">
                            <i class="bi bi-droplet"></i> Configure Thresholds
                        </a>
                        {% endif %}
                        <button class="btn btn-outline-danger" id="delete-device-btn">
                            <i class="bi bi-trash"></i> Delete Device
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteDeviceModal" tabindex="-1" aria-labelledby="deleteDeviceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteDeviceModalLabel">
                        <i class="bi bi-exclamation-triangle-fill"></i> デバイスの削除確認
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">以下のデバイスを本当に削除しますか？</p>
                    <div class="alert alert-warning">
                        <strong>デバイス名:</strong> {{ device.device_name }}<br>
                        <strong>デバイスID:</strong> <code>{{ device.device_id }}</code>
                    </div>
                    <p class="text-danger mb-0">
                        <i class="bi bi-info-circle-fill"></i>
                        この操作は元に戻せません。デバイスに関連するすべてのセンサーデータも削除されます。
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">
                        <i class="bi bi-trash"></i> 削除する
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const deleteBtn = document.getElementById('delete-device-btn');
    const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteDeviceModal'));
    const pageContainer = document.getElementById('device-detail-page');
    const deviceId = pageContainer.dataset.deviceId;

    // 削除ボタンクリック - モーダルを表示
    deleteBtn.addEventListener('click', function() {
        deleteModal.show();
    });

    // 確認ボタンクリック - デバイスを削除
    confirmDeleteBtn.addEventListener('click', async function() {
        confirmDeleteBtn.disabled = true;
        confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> 削除中...';

        try {
            const response = await fetch(`/api/device/${deviceId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (response.ok && result.success) {
                // 成功メッセージを表示してデバイス一覧ページにリダイレクト
                deleteModal.hide();
                showAlert('success', result.message, 'device-detail-alert-box');

                // 2秒後にデバイス一覧ページにリダイレクト
                setTimeout(function() {
                    window.location.href = "{{ url_for('devices.devices_profiles') }}";
                }, 2000);
            } else {
                throw new Error(result.message || 'デバイスの削除に失敗しました。');
            }
        } catch (error) {
            deleteModal.hide();
            showAlert('danger', `エラー: ${error.message}`, 'device-detail-alert-box');
            confirmDeleteBtn.disabled = false;
            confirmDeleteBtn.innerHTML = '<i class="bi bi-trash"></i> 削除する';
        }
    });
});
</script>
{% endblock %}
